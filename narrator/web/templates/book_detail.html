{% extends "base.html" %}
{% block title %}{{ book.title }} - Narrator{% endblock %}
{% block nav_library %}active{% endblock %}

{% block content %}
<div class="page-header">
    <a href="/library" class="back-link">&larr; Library</a>
</div>

<div class="book-detail">
    <div class="book-meta">
        <h1>{{ book.title }}</h1>
        <p class="book-author">{{ book.author }}</p>
        {% if book.series %}
        <p class="book-series">{{ book.series }} #{{ book.series_index }}</p>
        {% endif %}
        {% if book.description %}
        <p class="book-description">{{ book.description[:500] }}{% if book.description|length > 500 %}...{% endif %}</p>
        {% endif %}

        <div class="book-actions" x-data="{ voice: '{{ health.kokoro_voices }}' > 0 ? '' : 'af_heart' }">
            <select class="input select" x-model="voice" id="voice-select"
                    hx-get="/api/voices" hx-trigger="load" hx-swap="none"
                    x-init="fetch('/api/voices').then(r=>r.json()).then(d=>{
                        const sel = document.getElementById('voice-select');
                        if(d.voices && d.voices.length){
                            sel.innerHTML = d.voices.map(v=>'<option value=&quot;'+v+'&quot;>'+v+'</option>').join('');
                            voice = d.voices[0];
                        }
                    })">
                <option value="af_heart">af_heart (default)</option>
            </select>
            <button class="btn btn-primary"
                    @click="fetch('/api/books/{{ book.id }}/convert', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({voice:voice})}).then(r=>r.json()).then(d=>{if(d.job_id)window.location='/queue';else alert(d.detail||'Error')}).catch(()=>alert('Failed'))">
                Convert
            </button>
        </div>
    </div>
</div>

{% if chapters %}
<div class="section">
    <h2>Chapters ({{ chapters|length }})</h2>
    <table class="table">
        <thead>
            <tr>
                <th class="col-num">#</th>
                <th>Title</th>
                <th class="col-words">Words</th>
            </tr>
        </thead>
        <tbody>
            {% for ch in chapters %}
            <tr x-data="{ open: false }">
                <td class="col-num">{{ loop.index }}</td>
                <td>
                    <span class="chapter-title clickable" @click="open = !open">{{ ch.title }}</span>
                    <div class="chapter-preview" x-show="open" x-cloak>{{ ch.text[:300] }}...</div>
                </td>
                <td class="col-words">{{ ch.word_count }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if jobs %}
<div class="section">
    <h2>Conversion History</h2>
    <table class="table">
        <thead>
            <tr>
                <th>Voice</th>
                <th>Status</th>
                <th>Progress</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
            <tr class="{% if job.status.value == 'complete' %}row-success{% elif job.status.value == 'failed' %}row-error{% endif %}">
                <td>{{ job.voice }}</td>
                <td>
                    <span class="badge badge-{{ 'green' if job.status.value == 'complete' else 'red' if job.status.value == 'failed' else 'blue' }}">
                        {{ job.status.value }}
                    </span>
                </td>
                <td>{{ job.chapters_done }}/{{ job.chapters_total }}</td>
                <td>{{ job.created_at }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% endblock %}
